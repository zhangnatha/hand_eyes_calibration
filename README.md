# 2D/3D 相机 → 机器人手眼标定项目

## 项目简介
本项目为工业视觉与机器人协同开发提供了一套完善的标定与检测方案. 支持多种 2D 及 3D 相机的手眼标定（眼在手上/眼在手外）. **项目完整支持全部 12 种欧拉角旋转顺序及内外旋设置**, 适配全球主流工业机器人（如 KUKA, Fanuc, ABB, UR 等）, 并包含实时 ArUco 标记检测与 6DoF 位姿转换工具. 

---

## 支持的标定方式

### 1. 2D 相机标定
适用于相机与物体拍照距离恒定、物体在平面内运动的场景. 
*   **4点插针标定 (Four-Point Pin)**：
    *   **原理**：利用 4 组图像上特征点 (x,y) 及其对应的机器人物理平面坐标 (x,y), 建立仿射或透视变换映射. 
    *   **应用**：快速实现像素坐标到机器人工作空间的平面转换. 
*   **12点标定 (Twelve-Point Calibration)**：
    *   **原理**：由 9 点仿射变换（映射平移、旋转及缩放）与 3 点圆周运动拟合（求解旋转中心）组成. 
    *   **重要要求**：**要求 2D 相机与物体的拍照距离保持恒定**, 以确保尺度一致性. 
    *   **应用**：精确解耦机器人末端工具（TCP）的旋转中心. 

### 2. 3D 相机标定
适用于空间 6DoF 位姿解算、避障及复杂视觉引导. 
*   **基于标定球 (Ball-based)**：
    *   **原理**：通过在不同位置采集标定球心在相机坐标系下的 (x, y, z) 及其对应的机器人末端位姿 (x, y, z, rx, ry, rz), 求解手眼矩阵. 
*   **基于标定板 - 图像 (Board Image)**：
    *   **原理**：利用标定板图片的已知几何特征 (物理特征), 通过 OpenCV 的 PnP (Perspective-n-Point) 算法以及相机内参, 便可解算出标定板在相机坐标系下的位姿 (x, y, z, rx, ry, rz), 结合其对应的机器人末端位姿 (x, y, z, rx, ry, rz), 求解手眼矩阵. 
*   **基于标定板 - 图像+点云 (Board Image + Cloud) [实验性/需配置 PCL]**：
    *   **原理**：利用标定板 2D 角点像素坐标、点云查找表 (LUT) 、以及点云, 便可直接获取角点的 3D 位置 (x, y, z) , 结合其对应的机器人末端位姿 (x, y, z, rx, ry, rz), 求解手眼矩阵. 目前需手动开启 PCL 支持使用. 

### 3. 欧拉角约定 (Euler Angle Conventions)
在 3D 手眼标定中, **欧拉角顺序与参考系设置至关重要**. 不同品牌的机器人使用的约定各不相同：
*   **Significance**: 若设置错误, 机器人反馈的位姿 (RX, RY, RZ) 将无法正确转换为旋转矩阵, 导致标定严重偏离. 
*   **全面支持**: 项目通过 `RPY` 类完整支持全部 **12 种旋转顺序**、**内旋/外旋**, 以及 UR 机器人特有的 **旋转向量 (Rotation Vector / Axis-Angle)**. 这意味着 **UR 机器人无需任何预转换即可直接参与标定**. 
*   **示例**:
    *   **KUKA**: ZYX 外旋
    *   **Fanuc**: XYZ 外旋
    *   **UR (Universal Robots)**: `ROT_VECTOR` (旋转向量)

---

## 推荐标定板下载与设置
为了获得最佳标定效果, 建议使用以下标准标定板. 请在打印后核实 `cfg.interval_mm` (如方格边长) 的实际物理尺寸. 
- [经典棋盘格 (Chessboard)](https://raw.githubusercontent.com/opencv/opencv/4.x/doc/pattern.png) - 推荐规格: 9x6 或 7x6. 
- [非对称圆点 (Asymmetric Circles)](https://raw.githubusercontent.com/opencv/opencv/4.x/doc/acircles_pattern.png) - 推荐规格: 4x11. 

> 本项目中的标定板是基于**非对称圆点**制作的 4×5 个圆、间距为 20 mm 的标定板

---

## 代码结构说明
```text
├── 3rdparty/               # 第三方库依赖（OpenCV, Eigen, Realsense 等）
├── include/                # 头文件定义
│   ├── calibration/        # 核心标定逻辑
│   │   ├── 01_intrinsic/   # 相机内参标定
│   │   ├── 02_hand_eye_2d_4point/  # 2D 4点插针标定
│   │   ├── 03_hand_eye_2d_12point/ # 2D 12点标定
│   │   ├── 04_hand_eye_3d_ball/    # 3D 球心标定
│   │   ├── 05_hand_eye_3d_board_img/ # 3D 标定板图像算法
│   │   └── 06_hand_eye_3d_board_cloud/ # 3D 标定板图像+点云算法 (LUT-based)
│   ├── common/             # 共通模块（位姿定义、转换工具、相机驱动）
├── src/                    # 源代码实现
│   ├── calibration/        # 标定算法实现
│   └── common/             # 共通模块实现
├── assert/                 # 资源文件
│   ├── camera/             # 标定/测试用图像
│   └── patterns/           # 标定板样式图
├── calib.cpp               # 主标定程序入口
└── detect.cpp              # 实时检测与验证程序
```

---

## 环境搭建与运行

### 1. 依赖项
项目通过提供的脚本自动化管理依赖, 编译后会安装在 `3rdparty/` 目录下: 
- **OpenCV 4.x**: 用于图像处理、角点检测及 ArUco 识别, 运行 `bash build_opencv.sh` 即可. 
- **Eigen3**: 用于高效的矩阵运算, 运行 `bash build_eigen.sh` 即可. 
- **Realsense相机库**: 用于实时检测 `detect.cpp`, 运行 `bash build_realsense.sh` 即可. 
- **PCL (可选)**: 处理 `.pcd` 点云文件 (用于 `BoardCloudCalibrator`). 

### 2. 编译与运行
```bash
mkdir build && cd build
cmake .. && make -j8
./calib    # 执行标定
./detect mode="camera" xml="./calib_extrinsic.xml"  # 实时检测 (xml="calib_extrinsic.xml" mode="camera")
#./detect image="**.png" xml="./calib_extrinsic.xml"  # 离线检测 (xml="calib_extrinsic.xml" image="**.png")
```

---

## 实时检测任务 (`detect.cpp`)
标定完成后, 可运行 `detect` 进行实时验证：
- **ArUco 检测**：自动识别 ArUco 字典中的标记, 并实时解算其在相机坐标系下的 **6DoF 位姿**. 
- **坐标系转换**：读取 `calib_extrinsic.xml` 手眼矩阵, 将检测到的位姿从 **相机坐标系 (Camera)** 一键转换至 **机器人基座坐标系 (Base)**. 

---

## 标定结果示例与说明

> **提示**：主程序 `calib.cpp` 中提供了多个宏（如 `RUN_INTRINSIC`, `RUN_HAND_EYE_3D_BOARD_IMG` 等）, 您可以通过修改这些宏的开关来选择性地执行特定的标定任务. 

项目运行 `./calib` 后会依次输出各模块的标定结果. 以下为各功能的完整输出截取与含义解析：

### 1. 内参标定 (Intrinsic Calibration)
```text
=====================================================================
Category 1: Intrinsic Calibration                                                                                                                                                                                       
=====================================================================                                                                                                                                                      
进度: 20/20  有效: 11
第一次标定成功！RMS = 0.1592
内参:
[3528.077479357347, 0, 1601.668717280508;
0, 3528.407826555625, 1063.598597287287;
0, 0, 1]
畸变:
[-0.03191843214000115, -0.01315310417116016, 0.0004900759476249364, 0.000705387931759194, 0.4914825569033437]
```
*   **含义解析**：
    *   **RMS (0.1592)**：重投影均方根误差 (像素单位), 通常工业级相机标定该值应 **< 0.2**
    *   **内参矩阵 (Camera Matrix)**：包含焦距 `(fx, fy)` 和主点 `(cx, cy)`, `fx ≈ fy` 说明像素接近正方形
    *   **畸变系数 (Distortion)**: `k1, k2, p1, p2, k3`, 用于校正镜头引起的径向和切向畸变

### 2. 2D 4点插针标定 (4-Point Pin)
最基础的平移+旋转+缩放映射. 
```text
=====================================================================
   Category 3: 2D Camera Hand-Eye Calibration - 4-Point Pin                                                                                                                                                                
=====================================================================                                                                                                                                                      
[INFO] hand_eyes Homogeneous Matrix (2x3):
[0.002497689025360392, -0.2892431098781214, 1112.020940991345;
 -0.2892287874796049, -0.001915924547197932, 1477.02187947132]

[VERIFY] Four-point pin verification: Image(2035.0000,1093.0000) → Robot(800.9610, 886.3472)
```
*   **含义解析**：
    *   **2x3 矩阵**：仿射变换矩阵, 描述了像素坐标 `(u, v)` 到机器人坐标 `(x, y)` 的映射. 
    *   **Verification**：验证点. 输入特定的像素位置, 计算出机器人的物理坐标, 用于快速检查精度. 

### 3. 2D 12点标定 (12-Point - 高精度工具中心解耦)
包含 9 点映射与 3 点旋转中心拟合. 
```text
=====================================================================
   Category 4: 2D Camera Hand-Eye Calibration - 12-Point                                                                                                                                                                   
=====================================================================                                                                                                                                                      
[INFO] Index | Robot(dx,dy,rz) | Image(x,y,theta) | Error
------------------------------------------------------------------------------
  0 |     0.0000,     0.0000,     0.0000 |  1188.0000,   468.0000,     0.0000 |     0.0000
  1 |     0.0000,    30.0000,     0.0000 |  1173.0000,   467.0000,     0.0000 |    19.9885
  2 |    30.0000,    30.0000,     0.0000 |  1195.0000,   464.0000,     0.0000 |    48.8019
  3 |    30.0000,     0.0000,     0.0000 |  1320.0000,   474.0000,     0.0000 |     5.9699
  4 |    30.0000,   -30.0000,     0.0000 |  1249.0000,   593.0000,     5.0000 |    46.7405
  5 |     0.0000,   -30.0000,     0.0000 |  1292.0000,   545.0000,     7.0000 |    30.6642
  6 |   -30.0000,   -30.0000,     0.0000 |  1346.0000,   632.0000,     6.0000 |    43.3651
  7 |   -30.0000,     0.0000,     0.0000 |  1439.0000,   520.0000,     5.0000 |    53.1678
  8 |   -30.0000,    30.0000,     0.0000 |  1482.0000,   595.0000,     4.0000 |     5.9699
  9 |     0.0000,     0.0000,   -10.0000 |  1329.0000,   437.0000,     6.0000 |     0.0000
 10 |     0.0000,     0.0000,     0.0000 |  1239.0000,   472.0000,     0.0000 |     0.0000
 11 |     0.0000,     0.0000,    10.0000 |  1420.0000,   550.0000,   -14.0000 |     0.0000
[SUCCESS] 2D Twelve-point Calibration successful!
[INFO] Transform Pose (2x3 Affine Matrix):
0.1883, -0.3319, -68.3544
-0.0553, 0.2670, -59.2405

[INFO] Circle Fitting Result: 
center=(1317.1327, 539.6984), R=(103.3818)

[RESULT] TCP Rotation Center (relative to registration point): 129.1327, 71.6984
[VERIFY] Twelve-point verification: Image(1188.0000,468.0000) → Robot(0.0000, 0.0000, 0.0000°)
```
*   **含义解析**：
    *   **Error**：每个采样点的计算误差（像素单位）. 
    *   **Circle Fitting**：拟合末端法兰旋转时在图像中画出的圆. 
    *   **TCP Rotation Center**：机器人末端旋转中心在图像坐标系下的偏移. 

### 4. 3D 基于标定板 (Board Image)
通过 PnP 算法获取 6DoF. 
```text
=====================================================================
   Category 2: 3D Camera Hand-Eye Calibration - Based on Board Image                                                                                                                                                       
=====================================================================                                                                                                                                                      
[INFO] Index | Robot(x,y,z,rx,ry,rz) | Marker(x,y,z) | Error
--------------------------------------------------------------
  0 |   211.8920,  -415.1030,  -536.2130,   -91.1350,    44.2960,    11.7260 |   -48.4190,   -39.0447,   182.0946 |     0.1628
  1 |   217.3530,  -412.2230,  -530.4370,   -89.0570,    44.8960,    13.6510 |   -45.1920,   -33.7616,   175.3189 |     0.1211
  2 |   235.6810,  -408.3970,  -527.8700,   -87.6070,    45.0960,    15.7710 |   -44.0652,   -15.8169,   172.9567 |     0.0291
  3 |   235.6780,  -411.5970,  -527.8680,   -84.7620,    46.6410,    21.0560 |        N/A,        N/A,        N/A |        N/A
  4 |   252.3010,  -427.2810,  -524.4280,   -82.3120,    47.6570,    23.9280 |        N/A,        N/A,        N/A |        N/A
  5 |   251.6640,  -412.1560,  -518.1140,   -80.2040,    48.4660,    27.6480 |        N/A,        N/A,        N/A |        N/A
  6 |   250.3440,  -422.5220,  -520.9230,   -78.1080,    49.3240,    32.2180 |        N/A,        N/A,        N/A |        N/A
  7 |   252.9180,  -401.9310,  -541.1200,   -83.4480,    46.1700,    23.5150 |   -39.3325,    -2.6408,   184.6364 |     0.1636
  8 |   251.2060,  -386.2620,  -542.7550,   -85.8000,    45.1200,    20.0780 |   -24.6180,     1.0792,   187.6489 |     0.1290
  9 |   223.2810,  -378.4580,  -542.7600,   -88.3650,    44.2610,    16.8300 |   -13.3012,   -22.7906,   187.5328 |     0.1693
 10 |   219.7020,  -418.7900,  -536.2050,   -89.7370,    50.5690,    12.7340 |   -52.4181,   -39.4543,   179.0265 |     0.1730
 11 |   217.3920,  -412.2030,  -530.4340,   -91.8570,    39.0080,    18.5580 |   -49.0746,   -29.8605,   178.3993 |     0.1422
 12 |   235.6860,  -408.3950,  -527.8680,   -79.3440,    39.1030,    18.9830 |        N/A,        N/A,        N/A |        N/A
 13 |   235.6830,  -411.5970,  -535.1540,   -79.4810,    39.2390,    23.9530 |        N/A,        N/A,        N/A |        N/A
 14 |   245.7220,  -414.5400,  -523.7430,   -84.1420,    50.2070,    28.5740 |        N/A,        N/A,        N/A |        N/A
 15 |   256.1220,  -412.1520,  -526.1740,   -79.5610,    44.6770,    33.8590 |        N/A,        N/A,        N/A |        N/A
 16 |   238.3460,  -422.9750,  -530.8940,   -84.7300,    48.3060,    25.7530 |        N/A,        N/A,        N/A |        N/A
 17 |   252.9260,  -401.9320,  -536.6690,   -83.5120,    38.7620,    28.2180 |   -39.0754,     3.1062,   182.1032 |     0.0995
 18 |   251.2130,  -386.2620,  -542.7570,   -82.3520,    48.1520,    39.2760 |   -31.6516,   -11.6343,   184.4569 |     0.1093
 19 |   229.3520,  -374.5280,  -536.8770,   -86.5920,    38.1160,    17.0810 |    -7.9618,    -7.8107,   182.8147 |     0.1437
[SUCCESS] 3D Hand-Eye Calibration successful! Avg Error: 0.131140, Max: 0.173041, Min: 0.029107
[INFO] hand_eyes Homogeneous Matrix (Eigen format):
  -0.1920    0.9801    0.0502  207.7205
   0.9812    0.1927   -0.0100 -332.6460
  -0.0195    0.0474   -0.9987 -424.7441
   0.0000    0.0000    0.0000    1.0000

[RESULT] hand_eyes (Pose3D format): 
207.7205, -332.6460, -424.7441, 177.2844, 1.1158, 101.0728
```
*   **含义解析**：
    *   **RMS**：PnP 解算的重投影均方根误差. 越小表示图像特征识别越准. 
    *   **Avg Error**：手眼矩阵闭环后的物理平均误差（mm）. **0.13mm** 表示精度极佳. 
    *   **hand_eyes**：眼在手上-相机坐标系到机器人末端坐标系的转换关系, 眼在手外-相机坐标系到机器人基坐标系的转换关系. 

### 5. 3D 基于标定球 (Ball-based - 处理无纹理或大场景)
前提是获取到球心 XYZ . 
```text
=====================================================================
   Category 5: 3D Camera Hand-Eye Calibration - Based on Ball Center XYZ                                                                                                                                                   
=====================================================================                                                                                                                                                      
[INFO] Index | Robot(x,y,z,rx,ry,rz) | Marker(x,y,z) | Error
--------------------------------------------------------------
  0 | -1223.0700,  1493.1400,   774.3510,  -172.6910,   -14.0740,   170.7250 |  -107.0000,    -2.2500,   632.7500 |     3.0767
  1 | -1105.2500,  1370.0700,   774.3030,  -171.2130,   -18.8400,   153.0760 |    -3.7500,   -39.2500,   528.0000 |     2.5035
  2 | -1064.5600,  1424.3100,   808.0860,   166.7360,   -18.0350,   160.8740 |    48.7500,   -37.0000,   627.5000 |     2.8291
  3 | -1154.6400,  1396.6700,   780.3820,   168.4160,   -13.8180,   164.4820 |   -29.7500,   -14.2500,   580.2500 |     2.3280
  4 | -1099.2800,  1471.4400,   637.9320,  -170.2010,    -0.8750,   160.1770 |    46.7500,   108.7500,   584.5000 |     3.5364
  5 | -1215.1800,  1368.7200,   656.1080,  -173.2380,    14.4140,   173.6310 |   -19.5000,    59.7500,   490.7500 |     0.9278
  6 | -1148.4500,  1422.8000,   730.7530,  -176.3720,    10.7350,   163.3650 |    21.0000,     2.5000,   563.0000 |     1.5755
  7 | -1132.7600,  1358.1100,   775.3240,   178.9240,     4.6490,   171.3760 |    38.7500,   -47.2500,   525.7500 |     5.1851
  8 | -1231.2400,  1314.0300,   762.0050,   169.6000,   -10.5350,   173.2340 |   -89.2500,   -16.7500,   487.5000 |     3.4075
  9 | -1186.7200,  1408.2200,   682.3400,   174.9600,    -4.6410,   165.9100 |   -36.0000,    78.2500,   554.2500 |     4.8374
 10 | -1106.2600,  1441.8000,   686.1170,   179.9560,     0.5700,   152.8260 |    39.2500,    65.5000,   575.5000 |     2.4741
[SUCCESS] 3D Ball-based Calibration successful! Avg Error: 2.970991
[INFO] hand_eyes Homogeneous Matrix (Eigen format):
    0.9933    -0.0585     0.0994 -1182.4047
   -0.0824     0.2432     0.9665   818.1943
   -0.0807    -0.9682     0.2367   497.1121
    0.0000     0.0000     0.0000     1.0000

[RESULT] hand_eyes (Pose3D format): 
-1182.4047, 818.1943, 497.1121, -76.2616, 4.6280, -4.7413
```
*   **含义解析**：
    *   **Marker(x,y,z)**：相机检测到的球心坐标. 
    *   **Avg Error**：物理空间球心重合度的残差, 由于标定球识别精度受光照影响较大, 误差通常在几毫米级别. 
    *   **hand_eyes**：眼在手上-相机坐标系到机器人末端坐标系的转换关系, 眼在手外-相机坐标系到机器人基坐标系的转换关系.

### 6. 3D 基于标定板 (Image + Cloud) [实验性]
*   **状态**：此功能需链接 PCL 库并加载点云查找表（LUT）. 目前主要用于 3D 相机(需手动制作 2D-3D 映射表), 以跳过 PnP 步骤直接获得高精度点云坐标. 在 `./calib` 中默认未开启, 需修改 `RUN_HAND_EYE_3D_BOARD_CLOUD` 为 1. 

---

## 补充说明 (Supplementary Explanations)

### 1. 误差评估指南
*   **像素误差 (RMS/Reprojection Error)**：反映了图像特征提取的准确性. 对于 2D 和 3D-Board 标定, 该值通常应在 **0.1 - 0.5** 像素之间. 
*   **物理误差 (Avg/Max/Min Error)**：反映了机器人坐标与相机坐标转换后的吻合程度. 
    *   **3D 标定**：Avg Error 通常在 **0.1mm - 1.0mm**（取决于相机精度和机器人重复定位精度）. 
    *   **2D 标定**：Error 通常作为采样点的像素偏移, 需结合相机分辨率换算物理距离. 

### 2. Pose3D 与欧拉角格式
标定结果 `Pose3D` 以 `(x, y, z, rx, ry, rz)` 形式输出：
*   `x, y, z`：单位通常为 **mm**. 
*   `rx, ry, rz`：单位为 **度 (°)**. 
*   **注意**：输出的欧拉角顺序与您在 `setRPYType` 中设置的机器人约定保持一致（如 XYZ 外旋或 ZYX 内旋）. 

### 3. 如何获得最佳标定精度
1.  **覆盖范围**：采集点应尽量覆盖机器人工作的整个视野和深度范围. 
2.  **姿态丰富性**：在 3D 手眼标定中, **必须包含较大幅度的旋转姿态**, 单纯的平移无法准确解算出旋转矩阵. 
3.  **光照与清晰度**：确保标定板在所有图片中清晰、无反光、不产生阴影. 
4.  **核实尺寸**：打印标定板后, 务必用卡尺测量实际的 `interval_mm` 并更新到 `cfg`. 

### 4. 快速验证与应用
标定后生成的 `calib_extrinsic.xml` 可直接被 `detect.cpp` 调用. 
```bash
./detect mode="camera" xml="./calib_extrinsic.xml"
```
此时程序会实时将识别到的物体坐标转换到机器人坐标系下, 您可以通过示教器对比机器人的实际物理位置来验证标定效果. 
